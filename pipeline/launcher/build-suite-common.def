#------------------------------------------------------------------------------
# These sections are appended to all assembled suite-level singularity.def files,
# after replacing __VAR_NAME__ with ${VAR_NAME}.
#------------------------------------------------------------------------------
# https://sylabs.io/guides/latest/user-guide/definition_files.html
#------------------------------------------------------------------------------
# ENV_SUITE_DIR=/srv/env/SUITE_NAME is a suite-centric installation of SUITE_NAME
# that contains the Stage 1 environment (and Stage 1 library) builds.
# It is a fixed set of read-only files installed at build time.
#------------------------------------------------------------------------------
# MDI_SUITE_DIR=/srv/mdi/SUITE_NAME is a parallel SUITE_NAME installation bind-mounted 
# at run time, which is thus modifiable, e.g., to check out patch versions, etc.
# It provides the MDI code for running pipelines and apps, supported by ENV_SUITE_DIR.
#------------------------------------------------------------------------------

# copy the previously-versioned MDI tool suite repository into the container
%setup
    SRV_DIR=/srv
    ENV_DIR=${SINGULARITY_ROOTFS}${SRV_DIR}/env
    mkdir -p ${ENV_DIR}
    cp -r ./containers/tmp/__SUITE_NAME__ ${ENV_DIR}

# install the software required by pipeline actions as conda environments
# install Shiny and other R packages if container supports apps
%post

    # path variables set by us
    SRV_DIR=/srv
    MINICONDA_DIR=${SRV_DIR}/miniconda  
    export PATH=${MINICONDA_DIR}/bin:${PATH} 

    # variables set by mdi build
    SUITE_NAME=__SUITE_NAME__
    SUITE_VERSION=__SUITE_VERSION__
    SUITE_CONTAINER_VERSION=__SUITE_CONTAINER_VERSION__
    INSTALLER=__INSTALLER__
    export MDI_FORCE_PIPELINES=__MDI_FORCE_PIPELINES__
    export MDI_FORCE_APPS=__MDI_FORCE_APPS__
    export MDI_SKIP_APPS=__MDI_SKIP_APPS__
    ENV_SUITE_DIR=${SRV_DIR}/env/${SUITE_NAME}
    MDI_SUITE_DIR=${SRV_DIR}/mdi/${SUITE_NAME}

    # install git, conda, zip, and others as used by the MDI
    if [ "$INSTALLER" = "apt-get" ] || \
       [ "$INSTALLER" = "yum" ]; then
        $INSTALLER update && $INSTALLER install -y git wget zip time
    else 
        echo "unknown installer: $INSTALLER"
        exit 1
    fi
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ${SRV_DIR}/miniconda.sh
    bash ${SRV_DIR}/miniconda.sh -b -p ${MINICONDA_DIR} 

    # set conda channel_priority to strict
    # https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-channels.html#strict-channel-priority
    # https://github.com/conda/conda/issues/8197
    conda config --set channel_priority strict

    # execute the suite-centric installation of __SUITE_NAME__:__SUITE_VERSION__
    # flags set above will clone repos and continue to install Shiny if container:add_apps==true
    # unlike pipeline condas, app packages are installed for any suite dependencies also
    cd ${ENV_SUITE_DIR}
    ./install.sh
    cd ${ENV_SUITE_DIR}/mdi/suites/definitive/${SUITE_NAME}
    git checkout ${SUITE_VERSION}

    # creata conda environments for all __SUITE_NAME__:__SUITE_VERSION__ pipelines (but not it's suite dependencies)
    export IS_CONTAINER_BUILD=TRUE    
    PIPELINES=`ls -1 pipelines | grep -v -P "^_"`
    for PIPELINE in $PIPELINES; do 
        if [ ! -f $PIPELINE ]; then
            ${ENV_SUITE_DIR}/mdi/mdi ${PIPELINE} conda --create --force --no-mamba --version ${SUITE_VERSION} 
        fi
    done

    # clean up conda pkgs directory of cached tarballs (conda clean won't work here)
    rm -f ${MINICONDA_DIR}/pkgs/*.tar.bz2

# path overrides include all ways that running pipelines use files from mdi-pipelines-framework
# https://sylabs.io/guides/latest/user-guide/environment_and_metadata.html#environment-and-metadata
%environment 
    export LC_ALL=C
    export SRV_DIR=/srv
    export MINICONDA_DIR=${SRV_DIR}/miniconda     
    export PATH=${MINICONDA_DIR}/bin:${PATH}  
    export CONDA_LOAD_COMMAND=""   
    export CONDA_PROFILE_SCRIPT=${MINICONDA_DIR}/etc/profile.d/conda.sh
    export SUITE_NAME=__SUITE_NAME__
    export RUN_SCRIPT=__RUN_SCRIPT__
    export ENV_SUITE_DIR=${SRV_DIR}/env/${SUITE_NAME}
    export MDI_SUITE_DIR=${SRV_DIR}/mdi/${SUITE_NAME}
    export ENV_MDI_DIR=${ENV_SUITE_DIR}/mdi
    export ENVIRONMENTS_DIR=${ENV_MDI_DIR}/environments
    export R_LIBRARY_DIR=${ENV_MDI_DIR}/library
    # export FRAMEWORK_DIR=${MDI_DIR}/frameworks/definitive/mdi-pipelines-framework
    # export JOB_MANAGER_DIR=${FRAMEWORK_DIR}/job_manager
    # export LAUNCHER_DIR=${FRAMEWORK_DIR}/pipeline/launcher
    # export WORKFLOW_DIR=${FRAMEWORK_DIR}/pipeline/workflow
    # export WORKFLOW_SH=${WORKFLOW_DIR}/workflow.sh
    # export SLURP=${FRAMEWORK_DIR}/shell/slurp   
    # export RESOURCES_DIR=${MDI_DIR}/resources

# scriplet called by suite-centric 'run ...'; MDI_SUITE_DIR bound at runtime
%runscript
    exec bash ${MDI_SUITE_DIR}/${RUN_SCRIPT} $@

# labels for the container image, displayed as 'singularity inspect __SUITE_NAME__-__SUITE_CONTAINER_VERSION__.sif'
%labels
    Source Michigan Data Interface
    SuiteName __SUITE_NAME__
    SuiteVersion __SUITE_VERSION__
    ContainerBase __CONTAINER_BASE__
    ContainerBaseVersion __CONTAINER_BASE_VERSION__
    Apps __HAS_APPS__

# help text displayed by 'singularity run-help __SUITE_NAME__-__SUITE_CONTAINER_VERSION__.sif'
%help
    Source:    Michigan Data Interface
    Suite:     __SUITE_NAME__:__SUITE_VERSION__
    Base:      __CONTAINER_BASE__:__CONTAINER_BASE_VERSION__
    Apps:      __HAS_APPS__
